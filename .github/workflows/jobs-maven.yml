name: Fist Maven Pipeline

# eventos que gatillan el workflow ok
on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: write

# trabajos oki
jobs:
  security-scan:
    runs-on: ubuntu-latest
    #container: maven:3.8.5-openjdk-17
    steps:
    - uses: actions/checkout@v5
    - name: Validate POM version (semver x.y.z)
      id: validate_version
      run: |
        # Obtiene la versi칩n del POM
        VERSION="$(mvn -q -Dexpression=project.version -DforceStdout help:evaluate)"

        echo "POM version: ${VERSION}"

        # Regex semver simple: x.y.z (solo n칰meros)
        if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "::error title=Invalid version::La versi칩n '${VERSION}' no cumple el formato semver x.y.z"
          exit 1
        fi
        echo "POM_VERSION=$VERSION" >> "$GITHUB_ENV"

    - name: Validate POM version (semver x.y.z)
      uses: aldo2510/customized-actions/.github/actions/validate-pom@v1.0.4
      with:
        pom-path: pom.xml

    - name: Configurar Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::701109631773:role/Github-inspector
        aws-region: us-east-1

    - name: AWS Inspector SBOM Scan
      run: |
        # 1. Descargar la herramienta de escaneo de AWS
        curl -L -s https://amazon-inspector-sbomgen.s3.amazonaws.com/latest/linux/amd64/inspector-sbomgen.zip -o inspector-sbomgen.zip
        unzip inspector-sbomgen.zip
        # Buscar din치micamente el binario 
        BIN_PATH=$(find . -type f -name inspector-sbomgen) 
        
        # Moverlo a la ra칤z del workspace mv "$BIN_PATH" ./inspector-sbomgen
        chmod +x inspector-sbomgen
          
        # 2. Ejecutar el escaneo del repositorio actual
        # Esto genera un archivo 'scan_results.json'
        ./inspector-sbomgen directory --path ./ --output scan_results.json
          
        # 3. L칩gica de Build Break (Personalizable)
        # Buscamos si existen vulnerabilidades "CRITICAL" o "HIGH" en el archivo generado
        CRITICAL_COUNT=$(grep -c "CRITICAL" scan_results.json || true)
        HIGH_COUNT=$(grep -c "HIGH" scan_results.json || true)
          
        echo "Vulnerabilidades encontradas - Cr칤ticas: $CRITICAL_COUNT, Altas: $HIGH_COUNT"
          
        if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ]; then
          echo "游뚿 BUILD BREAK: Se encontraron vulnerabilidades no permitidas."
          exit 1
        fi 
 

    - name: Upload Scan Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: inspector-report  
        path: | 
          sbom-*.json

    - name: Build with Maven
      run: mvn clean package -DskipTests
      
    - name: Upload a Build Artifact
      uses: actions/upload-artifact@v4.6.2
      with:
        name: artifact
        path: target/*.jar

 
